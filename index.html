<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tawāfuq | منصّة وطنية لتنظيم الخطبة وبناء قرار زواج واعٍ</title>
  <meta name="description" content="توافق | Tawāfuq — منصّة وطنية ذكية لتنظيم الخطبة وبناء قرار زواج واعٍ عبر اختبارات توافق مقنّنة، تواصل شرعي منضبط، محتوى توعوي، وإرشاد أسري." />

  <!-- Open Graph -->
  <meta property="og:title" content="Tawāfuq | منصّة وطنية لتنظيم الخطبة وبناء قرار زواج واعٍ" />
  <meta property="og:description" content="اختبارات توافق مقنّنة، تواصل شرعي بإشراف، محتوى توعوي، وإرشاد أسري — مع تكاملات حكومية للموثوقية والخصوصية." />
  <meta property="og:type" content="website" />

  <!-- Performance hints -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">

  <!-- Tailwind via CDN -->
  <script defer src="https://cdn.tailwindcss.com"></script>

  <!-- Icons & charts & utils (all deferred) -->
  <script defer src="https://kit.fontawesome.com/4fdf4f8e7d.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --brand:#0EA5A8; --brand-dk:#0B7C7E; --sand:#E7D7C9; --accent:#8B5CF6;
      --brand-50:#ECFEFF; --brand-100:#CFFAFE; --brand-700:#0B7C7E;
      --success:#16A34A; --warn:#EAB308; --danger:#DC2626;
    }
    .bg-brand{ background: var(--brand); } .text-brand{ color: var(--brand); } .text-brand-dk{ color: var(--brand-dk); } .bg-sand{ background: var(--sand); }
    .badge{ display:inline-block; padding:.25rem .5rem; border:1px solid #e5e7eb; border-radius:.5rem; font-size:.75rem }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:1rem }

    /* Buttons */
    .btn{ padding:.6rem 1rem; border-radius:.75rem; font-weight:700; }
    .btn-brand{ background:var(--brand); color:#fff; }
    .btn-ghost{ background:#F3F4F6; }

    /* Top bar */
    header.topbar{ position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid #e5e7eb; backdrop-filter:saturate(180%) blur(6px); }
    .brand-right img{ height:40px; width:auto; }
    .brand-left img{ height:28px; width:auto; }
    .brand-left{ padding-left:10px } /* مسافة آمنة عن الحافة */
    @media (min-width:768px){ .brand-right img{ height:48px } .brand-left img{ height:32px } }

    /* Nav one-line */
    .main-nav{ white-space:nowrap; overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none; }
    .main-nav::-webkit-scrollbar{ display:none; }

    /* Print certificate only */
    @media print{
      header, aside, nav, #about, #accounts, #subs, #sponsor, #support, #kpis, #test .grid, #advisors-admin, #bookings, #governance, #policies, #terms, footer { display:none !important; }
      #resultsArea{ display:block !important; }
      #resultsArea .badge{ border:1px solid #000 !important; }
      body{ background:#fff; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden px-4 py-2 rounded-lg text-white"></div>

  <!-- ===== Header ===== -->
  <header class="topbar">
    <div class="max-w-7xl mx-auto px-3 sm:px-4">
      <div class="flex items-center justify-between py-3 gap-3">
        <!-- Right: Tawāfuq logo -->
        <div class="brand-right flex items-center gap-2 md:gap-3">
          <img src="Tawafuq.logo.svg" alt="شعار توافق Tawāfuq" loading="eager"/>
          <div class="hidden sm:block">
            <div class="text-xs text-gray-500">منصّة</div>
            <div class="text-lg md:text-xl font-extrabold text-brand-dk">Tawāfuq | توافق</div>
          </div>
        </div>

        <!-- Center: nav (one line) -->
        <nav class="main-nav flex-1 mx-2 md:mx-6">
          <ul class="flex items-center gap-3 md:gap-5 text-sm md:text-[15px]">
            <li><a href="#about" class="inline-block px-2 py-1 hover:text-brand">عن توافق</a></li>
            <li><a href="#accounts" class="inline-block px-2 py-1 hover:text-brand">الخدمات</a></li>
            <li><a href="#subs" class="inline-block px-2 py-1 hover:text-brand">الاشتراكات</a></li>
            <li><a href="#sponsor" class="inline-block px-2 py-1 hover:text-brand">الرعايات</a></li>
            <li><a href="#test" class="inline-block px-2 py-1 hover:text-brand">اختبار التوافق</a></li>
            <li><a href="#verify" class="inline-block px-2 py-1 hover:text-brand">استعلام</a></li>
            <li><a href="#wali" class="inline-block px-2 py-1 hover:text-brand">موافقة الولي</a></li>
            <li><a href="#advisors-admin" class="inline-block px-2 py-1 hover:text-brand">المستشارون</a></li>
            <li><a href="#bookings" class="inline-block px-2 py-1 hover:text-brand">الحجوزات</a></li>
            <li><a href="#kpis" class="inline-block px-2 py-1 hover:text-brand">المؤشرات</a></li>
          </ul>
        </nav>

        <!-- Left: Vision 2030 + Talbiya -->
        <div class="brand-left flex items-center gap-2 md:gap-3">
          <img src="vision2030.png" alt="شعار رؤية 2030" loading="lazy"/>
          <img src="talbiya.png" alt="شعار مبادرة تلبية" loading="lazy"/>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== Hero / About ===== -->
  <section id="about" class="bg-gradient-to-l from-[#F8FFFE] to-[#F3F6F6]">
    <div class="max-w-7xl mx-auto px-4 py-10 md:py-14">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <!-- KPIs mini -->
        <div class="card shadow-sm">
          <h3 class="font-bold text-gray-700 mb-4">(تجريبية) مؤشرات تشغيلية</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="border rounded-xl p-4"><div class="text-sm text-gray-500">جلسات محجوزة</div><div class="text-3xl font-extrabold">0</div></div>
            <div class="border rounded-xl p-4"><div class="text-sm text-gray-500">نسبة توافق متوسطة</div><div class="text-3xl font-extrabold text-brand">78%</div></div>
            <div class="border rounded-xl p-4"><div class="text-sm text-gray-500">مراكز شريكة</div><div class="text-3xl font-extrabold">8</div></div>
            <div class="border rounded-xl p-4"><div class="text-sm text-gray-500">اختبارات مكتملة</div><div class="text-3xl font-extrabold">0</div></div>
          </div>
          <div class="text-[12px] text-gray-400 mt-3">* بيانات للعرض فقط</div>
        </div>

        <!-- Intro + Vision/Mission/Goals -->
        <div>
          <div class="inline-block text-[12px] px-3 py-1 bg-white border rounded-full text-gray-600 mb-3">منصّة وطنية لتنظيم الخطبة وبناء قرار واعٍ</div>
          <h1 class="text-3xl md:text-5xl font-extrabold leading-[1.2] mb-4">
            توافق <span class="text-brand">Tawāfuq</span><br/>قرار زواج واثق ومستدام
          </h1>
          <p class="text-gray-600 leading-7 mb-4">«توافق» منصّة وطنية ذكية تُعين المقبلين على الزواج على اتخاذ قرار واعٍ ومستدام عبر اختبارات توافق مقنّنة، وتواصل شرعي منضبط، ومحتوى توعوي قصير، وإرشاد أسري متخصص — مع إمكانيّة التكامل مع الجهات الحكومية لرفع الموثوقية وحماية الخصوصية.</p>
          <div class="grid md:grid-cols-3 gap-3 text-sm">
            <div class="card"><div class="font-bold mb-1">الرؤية</div><div>أسرة واعية مستقرة، وقرار زواج موثوق ومستدام.</div></div>
            <div class="card"><div class="font-bold mb-1">الرسالة</div><div>تمكين المجتمع من قرار زواج واعٍ عبر أدوات علمية وإرشاد وخدمات موثوقة.</div></div>
            <div class="card"><div class="font-bold mb-1">الأهداف</div><div>خفض الطلاق المبكر، رفع جودة القرار، وتقليل التعثّر المالي.</div></div>
          </div>
          <div class="text-[12px] text-gray-500 mt-2">* المنصّة إحدى مبادرات <span class="font-semibold">برنامج شباب المملكة «حصيف» الوطني</span>.</div>
          <div class="flex flex-wrap gap-3 mt-4">
            <a href="#test" class="btn btn-brand">ابدأ اختبار التوافق</a>
            <a href="#accounts" class="btn btn-ghost">تعرّف أكثر</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="max-w-7xl mx-auto px-4 py-6 grid md:grid-cols-[260px_1fr] gap-6">
    <!-- Sidebar -->
    <aside class="bg-white border rounded-2xl p-4 h-max">
      <nav class="space-y-1 text-sm" aria-label="التنقل">
        <a href="#accounts" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-users ml-2"></i>الحسابات والخدمات</a>
        <a href="#subs" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-id-card ml-2"></i>الاشتراكات</a>
        <a href="#sponsor" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-hand-holding-heart ml-2"></i>باقات الرعاية</a>
        <a href="#support" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-life-ring ml-2"></i>الدعم الفني</a>
        <a href="#kpis" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-chart-line ml-2"></i>لوحة المؤشرات</a>
        <a href="#test" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-heart ml-2"></i>اختبار التوافق الذكي</a>
        <a href="#verify" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-qrcode ml-2"></i>استعلام الجهات</a>
        <a href="#wali" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-file-signature ml-2"></i>موافقة وليّ الأمر</a>
        <a href="#advisors-admin" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-user-tie ml-2"></i>إدارة المستشارين</a>
        <a href="#bookings" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-calendar-check ml-2"></i>حجوزات الجلسات</a>
        <a href="#governance" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-scale-balanced ml-2"></i>الحوكمة</a>
        <a href="#policies" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-shield ml-2"></i>الخصوصية</a>
        <a href="#terms" class="block px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-scroll ml-2"></i>الشروط</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="space-y-6">

      <!-- Accounts & Services -->
      <section id="accounts" class="card">
        <h2 class="text-xl font-bold mb-4">الحسابات والخدمات</h2>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="border rounded-xl p-4"><h3 class="font-bold text-brand-dk mb-1">حساب الأفراد</h3><ul class="list-disc pr-5 text-sm text-gray-700 space-y-1"><li>توثيق الهوية</li><li>اختبار التوافق</li><li>تواصل شرعي بإشراف</li><li>حجز جلسات</li><li>دورات ما قبل الزواج</li></ul></div>
          <div class="border rounded-xl p-4"><h3 class="font-bold text-brand-dk mb-1">أولياء الأمور</h3><ul class="list-disc pr-5 text-sm text-gray-700 space-y-1"><li>ربط الحساب</li><li>اطلاع بإذن</li><li>موافقة رقمية</li></ul></div>
          <div class="border rounded-xl p-4"><h3 class="font-bold text-brand-dk mb-1">المستشارون والمراكز</h3><ul class="list-disc pr-5 text-sm text-gray-700 space-y-1"><li>إدارة الجلسات</li><li>تقارير استشارية</li><li>تصنيف وتقييم</li></ul></div>
        </div>
      </section>

      <!-- Subscriptions -->
      <section id="subs" class="card">
        <h2 class="text-xl font-bold mb-3">الاشتراكات</h2>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="border rounded-xl p-4"><div class="font-bold">أساسي</div><div class="text-2xl font-extrabold text-brand">49 ر.س</div><ul class="text-sm text-gray-700 list-disc pr-5 mt-2"><li>التحقق من الهوية</li><li>اختبار أساسي</li></ul><button class="mt-3 btn btn-brand w-full" onclick="savePlan('basic')">اشترك</button></div>
          <div class="border rounded-xl p-4"><div class="font-bold">متقدّم</div><div class="text-2xl font-extrabold text-brand">149 ر.س</div><ul class="text-sm text-gray-700 list-disc pr-5 mt-2"><li>اختبار 30 سؤالًا</li><li>تقرير محاور</li></ul><button class="mt-3 btn btn-brand w-full" onclick="savePlan('pro')">اشترك</button></div>
          <div class="border rounded-xl p-4"><div class="font-bold">نخبوي</div><div class="text-2xl font-extrabold text-brand">299 ر.س</div><ul class="text-sm text-gray-700 list-disc pr-5 mt-2"><li>جلسة استشارية</li><li>شهادة PDF</li></ul><button class="mt-3 btn btn-brand w-full" onclick="savePlan('elite')">اشترك</button></div>
        </div>
      </section>

      <!-- Sponsors (doubled amounts) -->
      <section id="sponsor" class="card">
        <h2 class="text-xl font-bold mb-3">باقات الرعاية (مضاعفة)</h2>
        <div class="grid md:grid-cols-4 gap-4">
          <div class="border rounded-xl p-4"><div class="font-bold">برونزية</div><div class="text-2xl font-extrabold text-brand">100,000 ر.س</div></div>
          <div class="border rounded-xl p-4"><div class="font-bold">فضية</div><div class="text-2xl font-extrabold text-brand">300,000 ر.س</div></div>
          <div class="border rounded-xl p-4"><div class="font-bold">ذهبية</div><div class="text-2xl font-extrabold text-brand">600,000 ر.س</div></div>
          <div class="border rounded-xl p-4"><div class="font-bold">بلاتينية</div><div class="text-2xl font-extrabold text-brand">1,500,000 ر.س</div></div>
        </div>
      </section>

      <!-- Support -->
      <section id="support" class="card">
        <h2 class="text-xl font-bold mb-2">الدعم الفني</h2>
        <div class="grid md:grid-cols-3 gap-3">
          <label class="text-sm">الاسم<input id="supName" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
          <label class="text-sm">البريد<input id="supMail" type="email" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
          <label class="text-sm md:col-span-3">الرسالة<textarea id="supMsg" class="mt-1 w-full border rounded-lg px-3 py-2" rows="3"></textarea></label>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-brand" onclick="saveSupportDraft()">حفظ مسودة</button>
          <button class="btn btn-ghost" onclick="clearSupportDraft()">مسح</button>
        </div>
      </section>

      <!-- KPIs -->
      <section id="kpis" class="card">
        <h2 class="text-xl font-bold mb-3">لوحة مؤشرات تشغيلية</h2>
        <canvas id="kpiChart" height="100"></canvas>
      </section>

      <!-- Smart Test 30Q -->
      <section id="test" class="card">
        <h2 class="text-xl font-bold mb-4">اختبار التوافق الذكي (30 سؤالًا)</h2>
        <div class="grid md:grid-cols-3 gap-4 mb-4">
          <label class="text-sm">الدور
            <select id="party" class="mt-1 w-full border rounded-lg px-3 py-2">
              <option value="male">ذكر</option><option value="female">أنثى</option>
            </select>
          </label>
          <label class="text-sm">المنطقة<input id="region" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="مثال: حائل"/></label>
          <label class="text-sm">الديانة/المذهب<input id="religion" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="مثال: الإسلام"/></label>
          <label class="text-sm">العمر<input id="age" type="number" min="16" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
          <label class="text-sm">التعليم<input id="edu" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
          <label class="text-sm">الوضع المالي<select id="fin" class="mt-1 w-full border rounded-lg px-3 py-2"><option>مستقر</option><option>متوسط</option><option>قيد التحسن</option></select></label>
        </div>
        <div class="flex items-center gap-2 mb-3">
          <button class="btn btn-brand" onclick="createSession()"><i class="fa-solid fa-link ml-2"></i>إنشاء جلسة</button>
          <div class="text-sm">رمز الجلسة: <span class="font-mono" id="sessCode">—</span></div>
          <div class="flex items-center gap-2"><input id="joinCode" class="border rounded-lg px-2 py-1 text-sm" placeholder="أدخل رمز جلسة"/><button class="btn btn-ghost" onclick="joinSession()">انضمام</button></div>
        </div>
        <div id="questions" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex items-center gap-2">
          <button class="btn btn-brand" onclick="submitAnswers()">احتساب النتائج</button>
          <button class="btn btn-ghost" onclick="clearAnswers()">مسح الإجابات</button>
        </div>

        <div id="resultsArea" class="mt-6 hidden">
          <h3 class="text-lg font-bold mb-1">النتيجة</h3>
          <div class="text-2xl font-extrabold text-brand" id="finalScore">—%</div>
          <div id="axisBreakdown" class="mt-2 text-sm"></div>
          <div class="mt-3 flex flex-wrap gap-2">
            <span class="badge">رقم التوافق: <span class="font-mono" id="compatCode">—</span></span>
            <span class="badge">التاريخ: <span id="compatDate">—</span></span>
          </div>
          <div id="qrContainer" class="mt-3"></div>
          <div class="mt-3 flex gap-2">
            <button class="btn btn-brand" onclick="downloadCertificatePDF()"><i class="fa-solid fa-file-pdf ml-2"></i>تنزيل شهادة PDF</button>
            <button class="btn btn-ghost" onclick="window.print()"><i class="fa-solid fa-print ml-2"></i>طباعة</button>
          </div>
        </div>
      </section>

      <!-- Verify -->
      <section id="verify" class="card">
        <h2 class="text-xl font-bold mb-2">استعلام الجهات برقم التوافق</h2>
        <div class="flex items-center gap-2">
          <input id="verifyCode" class="border rounded-lg px-3 py-2" placeholder="مثال: TWFQ-AB12C-3"/>
          <button class="btn btn-brand" onclick="lookupVerification()">استعلام</button>
        </div>
        <div id="verifyBox" class="mt-3 hidden"></div>
      </section>

      <!-- Wali consent -->
      <section id="wali" class="card">
        <h2 class="text-xl font-bold mb-2">موافقة وليّ الأمر (تجريبية)</h2>
        <p class="text-sm text-gray-600 mb-3">بعد ظهور النتيجة، يمكن تسجيل موافقة وليّ الأمر على رقم التوافق باستخدام توقيع رقمي بسيط.</p>
        <div class="grid md:grid-cols-3 gap-3 mb-2">
          <label class="text-sm">اسم وليّ الأمر<input id="waliName" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
          <label class="text-sm">رقم الهوية<input id="waliNat" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
          <label class="text-sm">رقم التوافق<input id="waliCode" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="TWFQ-..."/></label>
        </div>
        <div class="border rounded-xl p-2 bg-white"><canvas id="signPad" class="w-full h-40 bg-sand rounded-lg"></canvas></div>
        <div class="mt-2 flex gap-2">
          <button class="btn btn-brand" onclick="saveWaliConsent()">حفظ الموافقة</button>
          <button class="btn btn-ghost" onclick="clearSign()">مسح التوقيع</button>
        </div>
        <div id="waliMsg" class="text-sm mt-2"></div>
      </section>

      <!-- Advisors Admin -->
      <section id="advisors-admin" class="card">
        <h2 class="text-xl font-bold mb-2">لوحة إدارة المستشارين (محلي للتجربة)</h2>
        <div class="grid md:grid-cols-4 gap-3 mb-3">
          <label class="text-sm">الاسم<input id="advName" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
          <label class="text-sm">التخصص<input id="advSpec" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="أسري/نفسي/شرعي"/></label>
          <label class="text-sm">أوقات متاحة (مثال: الأحد 6–9|الإثنين 7–10)<input id="advSlots" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
          <label class="text-sm">الحالة<select id="advApproved" class="mt-1 w-full border rounded-lg px-3 py-2"><option value="0">قيد المراجعة</option><option value="1">معتمد</option></select></label>
        </div>
        <div class="flex gap-2 mb-3">
          <button class="btn btn-brand" onclick="addAdvisor()">إضافة</button>
          <button class="btn btn-ghost" onclick="seedAdvisors()">تعبئة أمثلة</button>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead><tr class="text-right text-gray-600 border-b"><th class="py-2">#</th><th>الاسم</th><th>التخصص</th><th>الأوقات</th><th>الحالة</th><th>إجراءات</th></tr></thead>
            <tbody id="advTable"></tbody>
          </table>
        </div>
      </section>

      <!-- Bookings -->
      <section id="bookings" class="card">
        <h2 class="text-xl font-bold mb-2">حجوزات الجلسات (تجريبية محلية)</h2>
        <p class="text-sm text-gray-600 mb-4">احجز جلسة مع مستشار معتمد. تُحفَظ الحجوزات محليًا لأغراض العرض.</p>
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <label class="block text-sm">اختيار المستشار <select id="bkAdvisor" class="mt-1 w-full border rounded-lg px-3 py-2"></select></label>
          <label class="block text-sm">نوع الجلسة
            <select id="bkType" class="mt-1 w-full border rounded-lg px-3 py-2">
              <option value="استشارة أسرية 30 دقيقة">استشارة أسرية 30 دقيقة</option>
              <option value="استشارة نفسية 45 دقيقة">استشارة نفسية 45 دقيقة</option>
              <option value="استشارة شرعية 30 دقيقة">استشارة شرعية 30 دقيقة</option>
            </select>
          </label>
          <label class="block text-sm">التاريخ <input id="bkDate" type="date" class="mt-1 w-full border rounded-lg px-3 py-2" /></label>
          <label class="block text-sm">الوقت المتاح <select id="bkTime" class="mt-1 w-full border rounded-lg px-3 py-2"></select></label>
          <label class="block text-sm md:col-span-2">ملاحظات (اختياري)<input id="bkNotes" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="أي تفاصيل إضافية" /></label>
        </div>
        <div class="flex items-center gap-2 mb-6">
          <button class="btn btn-brand" onclick="addBooking()"><i class="fa-solid fa-check ml-2"></i>تأكيد الحجز</button>
          <button class="btn btn-ghost" onclick="seedBookings()">تعبئة أمثلة</button>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead><tr class="text-right text-gray-600 border-b"><th class="py-2">رقم الحجز</th><th>المستشار</th><th>النوع</th><th>التاريخ</th><th>الوقت</th><th>الحالة</th><th>إجراءات</th></tr></thead>
            <tbody id="bkTable"></tbody>
          </table>
        </div>
      </section>

      <!-- Governance -->
      <section id="governance" class="card">
        <h2 class="text-xl font-bold mb-2">الحوكمة والامتثال</h2>
        <ul class="list-disc pr-5 text-sm text-gray-700 space-y-1">
          <li>إنصاف الخوارزميات ومراجعة ربع سنوية</li>
          <li>سجلات إشرافية للمحادثات وفق الضوابط الشرعية</li>
          <li>إدارة الحوادث وسياسة الاحتفاظ بالبيانات</li>
          <li>تشفير البيانات الحساسة وتخزين محلي داخل المملكة</li>
          <li>مسؤول حماية البيانات: <span class="underline">dpo@talbiya.sa</span></li>
        </ul>
      </section>

      <!-- Policies & Terms -->
      <section id="policies" class="card"><h2 class="text-xl font-bold mb-2">سياسة الخصوصية (مختصر)</h2><p class="text-sm text-gray-700">نلتزم بمعالجة بيانات المستخدم وفق الأنظمة داخل المملكة؛ يتم التحقق عبر قنوات حكومية، وتُستخدم البيانات للأغراض التشغيلية والإحصائية بعد إخفاء الهوية.</p></section>
      <section id="terms" class="card"><h2 class="text-xl font-bold mb-2">الشروط والأحكام (مختصر)</h2><p class="text-sm text-gray-700">باستخدامك المنصّة، فأنت تلتزم بالضوابط الشرعية والسلوكية وعدم إساءة استخدام قنوات التواصل. يمكن تعليق أو إيقاف الحساب عند المخالفة.</p></section>

      <footer class="text-xs text-gray-600 py-6">© جميع الحقوق محفوظة لشركة <span class="font-semibold">تلبية للبحث والتطوير</span>. آخر تحديث: <span id="lastUpdated"></span></footer>
    </main>
  </div>

  <!-- ===== App Script ===== -->
  <script>
  // --- Toast helper ---
  function notify(type, msg){
    const el = document.getElementById('toast');
    const bg = type==='ok' ? 'bg-green-600' : type==='warn' ? 'bg-yellow-600' : 'bg-red-600';
    el.className = `fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white ${bg}`;
    el.textContent = msg; el.style.opacity=1; el.classList.remove('hidden');
    setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.classList.add('hidden'), 300); }, 2500);
  }

  // last updated
  document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('ar-SA');

  // Support draft
  const SUP_KEY='tawafuq_support_draft_v1';
  function saveSupportDraft(){ const o={n:supName.value,m:supMail.value,t:supMsg.value}; localStorage.setItem(SUP_KEY, JSON.stringify(o)); notify('ok','تم حفظ المسودة'); }
  function clearSupportDraft(){ localStorage.removeItem(SUP_KEY); supName.value=''; supMail.value=''; supMsg.value=''; notify('ok','تم المسح'); }
  function restoreSupportDraft(){ try{ const o=JSON.parse(localStorage.getItem(SUP_KEY)||'{}'); if(o.n) supName.value=o.n; if(o.m) supMail.value=o.m; if(o.t) supMsg.value=o.t; }catch(e){} }

  // Plan
  const PLAN_KEY='tawafuq_plan'; function savePlan(name){ localStorage.setItem(PLAN_KEY, name); notify('ok','تم حفظ الباقة: '+name); }

  // KPI chart
  function renderKPI(){ if(!window.Chart) return; const ctx=document.getElementById('kpiChart'); if(!ctx) return;
    new Chart(ctx,{ type:'bar', data:{ labels:['جلسات','اختبارات','توافق متوسط','مدن'], datasets:[{ label:'مؤشرات', data:[loadBookings().length, 3, 78, 5], backgroundColor:'#0EA5A8' }] }, options:{ responsive:true, plugins:{legend:{display:false}} } });
  }

  // Advisors Admin
  const ADV_KEY='tawafuq_advisors_v1';
  function loadAdvisors(){ try{ return JSON.parse(localStorage.getItem(ADV_KEY))||[] }catch(e){ return [] } }
  function saveAdvisors(x){ localStorage.setItem(ADV_KEY, JSON.stringify(x)); }
  function addAdvisor(){
    const a={ name:advName.value||'مستشار', spec:advSpec.value||'أسري', slots:advSlots.value||'الأحد 6–9', approved: advApproved.value==='1' };
    const list=loadAdvisors(); list.push(a); saveAdvisors(list); renderAdvisors(); notify('ok','تمت الإضافة');
    advName.value=''; advSpec.value=''; advSlots.value=''; advApproved.value='0';
  }
  function deleteAdvisor(i){ const list=loadAdvisors(); list.splice(i,1); saveAdvisors(list); renderAdvisors(); }
  function seedAdvisors(){ const demo=[
    {name:'أ. هدى العتيبي', spec:'أسري', slots:'الأحد 6–9|الثلاثاء 7–10', approved:true},
    {name:'د. مازن القحطاني', spec:'نفسي', slots:'الإثنين 6–9|الأربعاء 6–9', approved:false},
    {name:'الشيخ بندر السبيعي', spec:'شرعي', slots:'الخميس 7–9', approved:true},
  ]; saveAdvisors(demo); renderAdvisors(); notify('ok','تمت تعبئة الأمثلة'); }
  function renderAdvisors(){
    const body=document.getElementById('advTable'); if(!body) return;
    const list=loadAdvisors(); let html='';
    list.forEach((a,i)=>{
      html+=`<tr class="border-b"><td class="py-2">${i+1}</td><td>${a.name}</td><td>${a.spec}</td><td>${a.slots}</td><td>${a.approved?'معتمد':'قيد المراجعة'}</td><td><button class="px-2 py-1 text-xs border rounded-lg text-red-700" onclick="deleteAdvisor(${i})">حذف</button></td></tr>`;
    });
    body.innerHTML=html;
  }

  // Bookings
  var BK_KEY = 'tawafuq_bookings_v1';
  function loadBookings(){ try { return JSON.parse(localStorage.getItem(BK_KEY)) || []; } catch(e){ return []; } }
  function saveBookings(list){ localStorage.setItem(BK_KEY, JSON.stringify(list)); }
  function rebuildAdvisorSelect(){
    var sel = document.getElementById('bkAdvisor'); if(!sel) return;
    var list = loadAdvisors(); var html='';
    for(var i=0;i<list.length;i++){
      var a=list[i]; html += '<option value="'+i+'">'+a.name+' – '+a.spec+' ('+(a.approved? 'معتمد':'قيد المراجعة')+')</option>';
    }
    sel.innerHTML = html; rebuildTimeSlots();
  }
  function parseSlotsToOptions(slots){ if(!slots) return []; var first = String(slots).split('|')[0] || ''; var m = first.match(/([0-9]+)\s*–\s*([0-9]+)/); var s = m? parseInt(m[1]): 6; var e = m? parseInt(m[2]): 9; var out=[]; for(var h=s; h<e; h++){ out.push(h+':00'); out.push(h+':30'); } return out; }
  function rebuildTimeSlots(){ var timeSel = document.getElementById('bkTime'); if(!timeSel) return; var advSel = document.getElementById('bkAdvisor'); var list = loadAdvisors(); var adv = list[advSel && advSel.value ? parseInt(advSel.value) : 0]; var opts = parseSlotsToOptions(adv? adv.slots: ''); var html=''; for(var i=0;i<opts.length;i++){ html += '<option value="'+opts[i]+'">'+opts[i]+'</option>'; } timeSel.innerHTML = html; }
  function uid(){ return 'BK-' + Math.random().toString(36).slice(2,8).toUpperCase(); }
  function addBooking(){
    var advIdx = parseInt((document.getElementById('bkAdvisor')||{}).value||0);
    var list = loadAdvisors(); var adv = list[advIdx];
    if(!adv){ notify('err','أضف مستشارًا أولًا من لوحة إدارة المستشارين.'); return; }
    var rec = { id: uid(), advisor: adv.name, spec: adv.spec, type: (bkType.value||''), date: (bkDate.value||''), time: (bkTime.value||''), notes: (bkNotes.value||''), status: adv.approved? 'مؤكد' : 'بانتظار الاعتماد' };
    if(!rec.date || !rec.time){ notify('warn','اختر التاريخ والوقت.'); return; }
    var B = loadBookings(); B.push(rec); saveBookings(B); renderBookings();
    try { bookingPDF(rec); } catch(e){} notify('ok','تم إنشاء الحجز وإصدار PDF');
  }
  function renderBookings(){
    var body = document.getElementById('bkTable'); if(!body) return;
    var B = loadBookings(); var html='';
    for(var i=0;i<B.length;i++){
      var r=B[i];
      html += '<tr class="border-b">'
        +'<td class="py-2 font-mono">'+r.id+'</td>'
        +'<td>'+r.advisor+' <span class="text-gray-400">('+r.spec+')</span></td>'
        +'<td>'+r.type+'</td>'
        +'<td>'+r.date+'</td>'
        +'<td>'+r.time+'</td>'
        +'<td>'+(r.status==='مؤكد' ? '<span class="badge bg-sand border-[color:var(--brand)] text-brand-dk">مؤكد</span>' : '<span class="badge">بانتظار</span>')+'</td>'
        +'<td class="space-x-2 space-x-reverse"><button class="px-2 py-1 text-xs border rounded-lg" onclick="bookingPDFByIndex('+i+')">PDF</button><button class="px-2 py-1 text-xs border rounded-lg text-red-700" onclick="deleteBooking('+i+')">حذف</button></td>'
      +'</tr>';
    }
    body.innerHTML = html; rebuildAdvisorSelect();
  }
  function deleteBooking(i){ var B=loadBookings(); B.splice(i,1); saveBookings(B); renderBookings(); }
  function bookingPDFByIndex(i){ var B=loadBookings(); var rec=B[i]; if(rec) bookingPDF(rec); }
  function bookingPDF(rec){
    var jsPDF = window.jspdf.jsPDF; var doc = new jsPDF('p','pt','a4');
    var y=48; doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text('تأكيد حجز جلسة – Tawāfuq Session Confirmation', 48, y); y+=24;
    doc.setFontSize(12); doc.setFont('helvetica','');
    doc.text('رقم الحجز: '+rec.id, 48, y); y+=16;
    doc.text('المستشار: '+rec.advisor+' ('+rec.spec+')', 48, y); y+=16;
    doc.text('نوع الجلسة: '+rec.type, 48, y); y+=16;
    doc.text('التاريخ: '+rec.date+' | الوقت: '+rec.time, 48, y); y+=16;
    doc.text('الحالة: '+rec.status, 48, y); y+=24;
    if(rec.notes){ doc.text('ملاحظات: '+rec.notes, 48, y); y+=16; }
    doc.save('Booking_'+rec.id+'.pdf');
  }
  function seedBookings(){
    if(loadAdvisors().length===0) seedAdvisors();
    var a=loadAdvisors();
    var demo=[
      {id: uid(), advisor: (a[0]||{name:'أ. هدى'}).name, spec: 'أسري', type:'استشارة أسرية 30 دقيقة', date: new Date().toISOString().slice(0,10), time:'7:30', notes:'', status:'مؤكد'},
      {id: uid(), advisor: (a[1]||{name:'د. مازن'}).name, spec: 'نفسي', type:'استشارة نفسية 45 دقيقة', date: new Date(Date.now()+86400000).toISOString().slice(0,10), time:'6:00', notes:'', status:'بانتظار'}
    ]; saveBookings(demo); renderBookings();
  }

  // Smart Test session + Qs
  const SESS_KEY='tawafuq_sessions_v3';
  function loadSessions(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY))||{} }catch(e){ return {} } }
  function saveSessions(o){ localStorage.setItem(SESS_KEY, JSON.stringify(o)); }
  function genBase(){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<5;i++){ s+=chars[Math.floor(Math.random()*chars.length)] } return s }
  function genCode(){ const base=genBase(); let sum=0; for(const ch of base){ sum+=ch.charCodeAt(0) } const chk=(sum%7).toString(); return `TWFQ-${base}-${chk}` }
  function validCodeFormat(code){ return /^TWFQ\-[A-Z0-9]{5}\-\d$/.test(code||'') }
  let currentCode=null, currentParty=null;

  function createSession(){
    currentParty = document.getElementById('party').value;
    const meta = { region:region.value||'', religion:religion.value||'', age:parseInt(age.value||'0'), edu:edu.value||'', fin:fin.value||'' };
    const code=genCode(); const sessions=loadSessions();
    sessions[code] = sessions[code]||{ male:null, female:null, meta:{} };
    sessions[code].meta[currentParty]=meta; saveSessions(sessions);
    currentCode=code; document.getElementById('sessCode').textContent=code; notify('ok','تم إنشاء الجلسة: '+code);
    buildQuestions(); restoreProgress();
  }
  function joinSession(){
    const code=(document.getElementById('joinCode').value||'').trim().toUpperCase();
    if(!validCodeFormat(code)) return notify('warn','صيغة الرمز غير صحيحة');
    const s=loadSessions()[code]; if(!s) return notify('err','لا توجد جلسة بهذا الرمز');
    currentCode=code; currentParty=document.getElementById('party').value;
    document.getElementById('sessCode').textContent=code; notify('ok','تم الانضمام إلى الجلسة');
    buildQuestions(); restoreProgress();
  }

  const AXES=[
    {key:'values', title:'القيم', weight:0.25},
    {key:'goals', title:'الأهداف', weight:0.20},
    {key:'traits', title:'السمات', weight:0.20},
    {key:'finance', title:'المال', weight:0.15},
    {key:'comm', title:'التواصل', weight:0.20},
  ];
  const BANK={
    values:['أهمية الالتزام الديني','الصدق والشفافية','دور الأسرة الممتدة','التمسك بالتقاليد','مرونة الاختلاف الديني','العمل التطوعي'],
    goals:['إنجاب مبكر','الاستقرار السكني قبل الإنجاب','الدراسات العليا بعد الزواج','طموح مهني للطرفين','الادخار طويل المدى','السفر كأسلوب حياة'],
    traits:['ضبط النفس عند الخلاف','التسامح بعد الاعتذار','المرونة في الخطط','الانفتاح على الجديد','الدقة في المواعيد','حب النظام'],
    finance:['تقسيم المصاريف بالتساوي','الالتزام بميزانية شهرية','تفضيل الادخار','شفافية مالية كاملة','تقاسم إدارة الأموال','أولويات الرفاه والهدايا'],
    comm:['حوار يومي ≥15 دقيقة','تقبّل النقد البنّاء','الاعتذار السريع','التعبير عن المشاعر','حل الخلاف في نفس اليوم','عدم إدخال أطراف مبكرًا']
  };

  function buildQuestions(){
    const box=document.getElementById('questions'); if(!box) return; box.innerHTML='';
    let i=0; AXES.forEach(ax=>{
      BANK[ax.key].forEach(q=>{
        i++; const id=`q_${ax.key}_${i}`;
        const wrap=document.createElement('label'); wrap.className='text-sm block'; wrap.setAttribute('for', id);
        wrap.innerHTML = `${i}. ${q}<select id="${id}" class="mt-1 w-full border rounded-lg px-3 py-2"><option value="">— اختر —</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>`;
        box.appendChild(wrap);
      })
    });
    // autosave
    box.querySelectorAll('select').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const key='tawafuq_progress_'+currentCode+'_'+currentParty; const obj=JSON.parse(localStorage.getItem(key)||'{}');
        obj[sel.id]=sel.value; localStorage.setItem(key, JSON.stringify(obj));
      });
    });
  }
  function restoreProgress(){ if(!currentCode||!currentParty) return; const key='tawafuq_progress_'+currentCode+'_'+currentParty; const obj=JSON.parse(localStorage.getItem(key)||'{}'); Object.keys(obj).forEach(id=>{ const el=document.getElementById(id); if(el) el.value=obj[id]; }); }
  function clearAnswers(){ const box=document.getElementById('questions'); if(!box) return; box.querySelectorAll('select').forEach(s=>s.value=''); notify('ok','تم المسح'); }

  function gatherAnswers(){
    const box=document.getElementById('questions'); const answers={}; let valid=true;
    AXES.forEach(ax=>{ answers[ax.key]=[]; });
    box.querySelectorAll('select').forEach(s=>{ if(!s.value) valid=false; const [_,key]=s.id.split('_'); answers[key].push(parseInt(s.value)); });
    return {answers, valid};
  }

  function computeAxisScore(arr){ if(!arr.length) return 0; const sum=arr.reduce((a,b)=>a+b,0); const max=arr.length*5; return Math.round((sum/max)*100); }
  function similarityScore(a1,a2){ const len=Math.min(a1.length, a2.length); let sim=0; for(let i=0;i<len;i++){ sim += 1 - (Math.abs(a1[i]-a2[i])/4); } return Math.round((sim/len)*100); }

  function demoSimilarity(m,f){
    if(!m||!f) return 0; let s=0, n=0;
    if(m.age && f.age){ const d=Math.abs(m.age-f.age); s += (d<=3?100:(d<=6?70:40)); n++; }
    if(m.edu && f.edu){ s += (m.edu===f.edu?100:60); n++; }
    if(m.region && f.region){ s += (m.region===f.region?100:70); n++; }
    if(m.religion && f.religion){ s += (m.religion===f.religion?100:60); n++; }
    if(m.fin && f.fin){ s += (m.fin===f.fin?100:70); n++; }
    return Math.round(s/Math.max(n,1));
  }

  function submitAnswers(){
    if(!currentCode||!currentParty) return notify('warn','أنشئ أو انضم إلى جلسة أولًا');
    const {answers, valid}=gatherAnswers(); if(!valid) return notify('warn','أكمل جميع الإجابات');
    const sessions=loadSessions(); const S=sessions[currentCode]||{ male:null, female:null, meta:{} };
    const pack={ answers, meta:{ region:region.value, religion:religion.value, age:parseInt(age.value||'0'), edu:edu.value, fin:fin.value } };
    S[currentParty]=pack; sessions[currentCode]=S; saveSessions(sessions);

    if(S.male && S.female){
      const axisScores={}; let total=0;
      AXES.forEach(ax=>{
        const sim=similarityScore(S.male.answers[ax.key], S.female.answers[ax.key]);
        axisScores[ax.key]=sim; total += sim*ax.weight;
      });
      const dm = demoSimilarity(S.male.meta, S.female.meta);
      const final = Math.round(total*0.75 + dm*0.25);
      showResults(final, axisScores);
      localStorage.removeItem('tawafuq_progress_'+currentCode+'_male');
      localStorage.removeItem('tawafuq_progress_'+currentCode+'_female');
    } else {
      notify('ok','تم حفظ إجاباتك. بانتظار الطرف الآخر.');
    }
  }

  function showResults(final, axis){
    const code = currentCode; const date=new Date().toLocaleDateString('ar-SA');
    document.getElementById('resultsArea').classList.remove('hidden');
    document.getElementById('finalScore').textContent=final+'%';
    document.getElementById('compatCode').textContent=code;
    document.getElementById('compatDate').textContent=date;
    const mapTitle={values:'القيم', goals:'الأهداف', traits:'السمات', finance:'المال', comm:'التواصل'};
    let html=''; Object.keys(axis).forEach(k=>{ html+=`<div class="badge">${mapTitle[k]}: ${axis[k]}%</div> ` });
    document.getElementById('axisBreakdown').innerHTML=html;

    const qrBox=document.getElementById('qrContainer'); qrBox.innerHTML='';
    const div=document.createElement('div'); qrBox.appendChild(div);
    const payload = JSON.stringify({code, score:final});
    new QRCode(div, {text: payload, width:128, height:128});

    notify('ok','تم احتساب النتيجة');
  }

  function dataURLFromQRCodeElement(el){
    const img=el.querySelector('img'); if(img) return img.src;
    const cvs=el.querySelector('canvas'); if(cvs) return cvs.toDataURL('image/png');
    return null;
  }

  function downloadCertificatePDF(){
    const jsPDF=window.jspdf.jsPDF; const doc=new jsPDF('p','pt','a4');
    const code=document.getElementById('compatCode').textContent||'';
    const score=document.getElementById('finalScore').textContent||'';
    const date=document.getElementById('compatDate').textContent||'';
    let y=56; doc.setFont('helvetica','bold'); doc.setFontSize(20);
    doc.text('شهادة توافق – Tawāfuq Compatibility Certificate', 48, y); y+=28;
    doc.setFont('helvetica',''); doc.setFontSize(12);
    doc.text('رقم التوافق: '+code, 48, y); y+=16; doc.text('النسبة النهائية: '+score, 48, y); y+=16; doc.text('التاريخ: '+date, 48, y); y+=24;
    const qc=document.getElementById('qrContainer'); const dataURL=dataURLFromQRCodeElement(qc);
    if(dataURL){ doc.addImage(dataURL, 'PNG', 48, y, 96, 96); y+=112; }
    doc.text('هذه شهادة تجريبية محلية لأغراض العرض.', 48, y);
    doc.save('Tawafuq_Certificate_'+code+'.pdf');
  }

  // Verify lookup
  function lookupVerification(){
    const code=(document.getElementById('verifyCode').value||'').trim().toUpperCase();
    const box=document.getElementById('verifyBox'); box.classList.remove('hidden');
    if(!validCodeFormat(code)){ box.innerHTML='<div class="text-red-700">صيغة الرقم غير صحيحة.</div>'; return; }
    const S=loadSessions()[code]; if(!S||!S.male||!S.female){ box.innerHTML='<div class="text-yellow-700">لا تتوفر بيانات مكتملة لهذا الرقم.</div>'; return; }
    const axis={}; let total=0; AXES.forEach(ax=>{ const sim=similarityScore(S.male.answers[ax.key], S.female.answers[ax.key]); axis[ax.key]=sim; total+=sim*ax.weight; });
    const dm=demoSimilarity(S.male.meta,S.female.meta); const final=Math.round(total*0.75+dm*0.25);
    const mapTitle={values:'القيم', goals:'الأهداف', traits:'السمات', finance:'المال', comm:'التواصل'};
    let badges=''; Object.keys(axis).forEach(k=>{ badges+=`<span class="badge">${mapTitle[k]}: ${axis[k]}%</span> `; });
    box.innerHTML = `<div class="p-3 bg-white border rounded-xl"><div class="text-lg font-bold text-brand">${final}%</div><div class="mt-2">${badges}</div><div class="text-xs text-gray-500 mt-2">نتيجة محسوبة محليًا (تجريبي)</div></div>`;
  }

  // Wali consent signature
  let drawing=false;
  function signInit(){ const c=document.getElementById('signPad'); if(!c) return; const ctx=c.getContext('2d'); ctx.strokeStyle='#000'; ctx.lineWidth=2;
    function pos(e){ const r=c.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; }
    c.addEventListener('mousedown',e=>{drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y)});
    c.addEventListener('mousemove',e=>{ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
    window.addEventListener('mouseup',()=>drawing=false);
    c.addEventListener('touchstart',e=>{drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y)});
    c.addEventListener('touchmove',e=>{ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
    window.addEventListener('touchend',()=>drawing=false);
  }
  function clearSign(){ const c=document.getElementById('signPad'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
  function saveWaliConsent(){
    const name=waliName.value||''; const nat=waliNat.value||''; const code=(waliCode.value||'').toUpperCase();
    if(!name||!nat||!validCodeFormat(code)) return notify('warn','أكمل البيانات وتحقق من صيغة الرقم');
    const S=loadSessions(); if(!S[code]) return notify('err','رقم توافق غير موجود');
    const c=document.getElementById('signPad'); const png=c.toDataURL('image/png');
    S[code].wali={ name, nat, sign: png, at: new Date().toISOString() }; saveSessions(S);
    document.getElementById('waliMsg').textContent='تم حفظ موافقة وليّ الأمر.'; notify('ok','حُفظت الموافقة');
  }

  // Init
  document.addEventListener('DOMContentLoaded',function(){
    restoreSupportDraft(); renderAdvisors(); rebuildAdvisorSelect(); renderBookings(); renderKPI(); signInit();
  });

  // ===== PWA (single-file) =====
  (function oneFilePWA(){
    const manifest = { name:"Tawāfuq", short_name:"Tawāfuq", start_url:".", display:"standalone", background_color:"#ffffff", theme_color:"#0EA5A8", icons:[] };
    const mURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'}));
    const link = document.createElement('link'); link.rel='manifest'; link.href=mURL; document.head.appendChild(link);
    const swCode = `
      self.addEventListener('install', e=>{ e.waitUntil(caches.open('tawafuq-v1').then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('activate', e=> self.clients.claim());
      self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))) });
    `;
    const swURL = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
    if('serviceWorker' in navigator){ navigator.serviceWorker.register(swURL).catch(()=>{}); }
  })();
  </script>
</body>
</html>
