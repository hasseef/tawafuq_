<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>توافق | Tawāfuq — منصّة وطنية لتنظيم الخطبة وبناء قرار زواج واعٍ</title>
  <meta name="description" content="منصّة وطنية ذكية تقلّل الطلاق المبكر وترفع جودة قرار الزواج عبر اختبارات توافق، تواصل شرعي بإشراف، ومحتوى توعوي." />

  <!-- Tailwind -->
  <script defer src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script defer src="https://kit.fontawesome.com/4fdf4f8e7d.js" crossorigin="anonymous"></script>
  <!-- Charts / PDF / QR -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      /* ألوان هوية توافق الرسمية */
      --brand:#0EA5A8; --brand-dk:#0B7C7E; --sand:#E7D7C9; --accent:#8B5CF6;
      --ink:#0f172a; --muted:#64748b; --surface:#ffffff;
      --success:#16A34A; --warn:#EAB308; --danger:#DC2626;
    }
    .bg-brand{background:var(--brand)} .text-brand{color:var(--brand)} .text-brand-dk{color:var(--brand-dk)}
    .bg-sand{background:var(--sand)}
    .card{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:1.25rem;padding:1.25rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.65rem 1rem;border-radius:.9rem;font-weight:700}
    .btn-brand{background:var(--brand);color:#fff}
    .btn-ghost{background:#f3f4f6}
    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border:1px solid rgba(15,23,42,.08);border-radius:.7rem;font-size:.8rem}
    .shadow-soft{box-shadow:0 10px 30px rgba(14,165,168,.15)}
    .hero-grad{background:
      radial-gradient(1200px 500px at 70% -10%, rgba(14,165,168,.18), transparent 60%),
      radial-gradient(1000px 500px at -10% 10%, rgba(139,92,246,.12), transparent 60%)}
    section{scroll-margin-top:90px}
    .badge{ display:inline-block; padding:.25rem .5rem; border:1px solid #e5e7eb; border-radius:.5rem; font-size:.75rem }
    @media print{ nav, header, footer, #hero {display:none!important} #resultsArea{display:block!important} }

    /* الهيدر: تموضع واستجابة الشعارات والقوائم (سطر واحد) */
    .brand-area img{height:40px;width:auto}
    @media (min-width:768px){ .brand-area img{height:44px} }
    .nav-link{white-space:nowrap} /* منع نزول العناوين لسطرين */
    header .wrap{gap:.75rem}
    @media (min-width:768px){ header .wrap{gap:1rem} }

    /* حافة آمنة لليسار حتى لا يلتصق شعار تلبية/الرؤية */
    .safe-left{padding-left:.5rem}
    @media (min-width:768px){ .safe-left{padding-left:.75rem} }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">
  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden px-4 py-2 rounded-lg text-white"></div>

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur border-b sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between wrap">
      <!-- يمين: شعار توافق (واحد فقط) -->
      <a href="#hero" class="brand-area order-1 flex items-center">
        <!-- ضع ملف الشعار في الجذر بنفس الاسم التالي -->
        <img src="Tawafuq.logo.svg" alt="شعار توافق Tawāfuq" title="Tawāfuq" />
      </a>

      <!-- وسط: التنقّل (سطر واحد) -->
      <nav class="hidden md:flex order-2 items-center gap-1 text-sm">
        <a href="#about" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">عن توافق</a>
        <a href="#journeys" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">رحلات المستفيد</a>
        <a href="#kpis" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">المؤشرات</a>
        <a href="#features" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">المزايا</a>
        <a href="#test" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">اختبار التوافق</a>
        <a href="#solo" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">الوضع الفردي</a>
        <a href="#verify" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">استعلام</a>
        <a href="#wali" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">موافقة الولي</a>
        <a href="#bookings" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">الحجوزات</a>
        <a href="#plans" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">الاشتراكات</a>
        <a href="#contact" class="px-3 py-2 rounded-lg hover:bg-gray-100 nav-link">تواصل</a>
      </nav>

      <!-- يسار: رؤية 2030 + تلبية (أصغر قليلًا + مسافة آمنة من الطرف) -->
      <div class="brand-area order-3 flex items-center gap-3 safe-left">
        <img src="vision2030.png" alt="شعار رؤية السعودية 2030" title="Vision 2030" />
        <img src="talbiya.png" alt="شعار مبادرة تلبية" title="Talbiya Initiative" />
      </div>

      <!-- زر البدء -->
      <a href="#plans" class="btn btn-brand shadow-soft text-sm md:ml-2"><i class="fa-solid fa-id-card ml-1"></i>ابدأ الآن</a>
    </div>
  </header>

  <!-- HERO -->
  <section id="hero" class="hero-grad">
    <div class="max-w-7xl mx-auto px-4 py-12 md:py-16 grid md:grid-cols-2 gap-8 items-center">
      <div>
        <div class="inline-flex items-center gap-2 chip mb-4">
          <i class="fa-solid fa-shield-heart ml-1 text-brand"></i>
          منصّة وطنية لتنظيم الخطبة وبناء قرار زواج واعٍ
        </div>
        <h1 class="text-3xl md:text-5xl font-extrabold leading-[1.2] text-slate-900">
          توافق <span class="text-brand">Tawāfuq</span><br>
          قرار زواج <span class="underline decoration-[var(--brand)]">واثق</span> ومستدام
        </h1>
        <p class="mt-4 text-slate-600 leading-7 md:pr-2">
          اختبارات توافق مقنّنة، تواصل شرعي بإشراف، محتوى توعوي قصير، وإرشاد أسري — مع إمكانية التكامل مع الجهات الحكومية
          لرفع الموثوقية وحماية الخصوصية.
        </p>
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#test" class="btn btn-brand shadow-soft"><i class="fa-solid fa-heart-pulse ml-1"></i>ابدأ اختبار التوافق</a>
          <a href="#about" class="btn btn-ghost"><i class="fa-solid fa-circle-info ml-1"></i>تعرّف أكثر</a>
        </div>
        <div class="mt-5 flex flex-wrap gap-2 text-sm">
          <span class="chip"><i class="fa-solid fa-lock ml-1"></i>تحقق الهوية</span>
          <span class="chip"><i class="fa-solid fa-heart-circle-check ml-1"></i>مؤشر توافق وطني</span>
          <span class="chip"><i class="fa-solid fa-user-tie ml-1"></i>استشارات معتمدة</span>
        </div>
      </div>
      <!-- KPIs Mini -->
      <div class="card shadow-soft">
        <div class="text-sm text-slate-500 mb-2">مؤشرات تشغيلية (تجريبية)</div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 rounded-2xl border">
            <div class="text-xs text-slate-500">نسبة توافق متوسّطة</div>
            <div class="text-3xl font-extrabold text-brand" id="kpiAvg">—%</div>
          </div>
          <div class="p-4 rounded-2xl border">
            <div class="text-xs text-slate-500">جلسات محجوزة</div>
            <div class="text-3xl font-extrabold" id="kpiBookings">0</div>
          </div>
          <div class="p-4 rounded-2xl border">
            <div class="text-xs text-slate-500">اختبارات مكتملة</div>
            <div class="text-3xl font-extrabold" id="kpiTests">0</div>
          </div>
          <div class="p-4 rounded-2xl border">
            <div class="text-xs text-slate-500">مراكز شريكة</div>
            <div class="text-3xl font-extrabold" id="kpiCenters">8</div>
          </div>
        </div>
        <div class="mt-4 text-xs text-slate-500">* بيانات للعرض فقط</div>
      </div>
    </div>
  </section>

  <!-- لوحة مؤشرات -->
  <section id="kpis" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="card">
      <h2 class="text-xl font-bold mb-4">لوحة مؤشرات تشغيلية</h2>
      <canvas id="kpiChart" height="110" aria-label="مخطط مؤشرات"></canvas>
    </div>
  </section>

  <!-- عن توافق -->
  <section id="about" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="grid md:grid-cols-3 gap-6">
      <div class="card"><div class="text-brand-dk font-bold mb-1">تحقق وهوية</div><p class="text-slate-600 text-sm">تكاملات حكومية للتحقق والموثوقية، مع تشفير وتخزين محلي داخل المملكة.</p></div>
      <div class="card"><div class="text-brand-dk font-bold mb-1">مؤشر توافق</div><p class="text-slate-600 text-sm">اختبارات قيم/أهداف/سمات/مال/تواصل لتوليد نسبة توافق مفصلة وتوصيات عملية.</p></div>
      <div class="card"><div class="text-brand-dk font-bold mb-1">إشراف واستشارات</div><p class="text-slate-600 text-sm">تواصل شرعي بإشراف + جلسات استشارية معتمدة وخطط نقاش إلزامية عند الحاجة.</p></div>
    </div>
  </section>

  <!-- رحلات المستفيد -->
  <section id="journeys" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="card">
      <h2 class="text-xl font-bold mb-3">رحلات المستفيد</h2>
      <ol class="grid md:grid-cols-2 gap-3 text-sm text-slate-700 leading-7 list-decimal pr-5">
        <li>التعرّف: قراءة التعريف والمزايا وسياسات الخصوصية.</li>
        <li>التهيئة: توثيق الهوية واختيار الخطة المناسبة.</li>
        <li>الاختبار: جلسة مشتركة برمز موحد أو عبر <b>الوضع الفردي</b>.</li>
        <li>النتيجة: نسبة إجمالية وتفصيل محاور مع شهادة PDF وQR.</li>
        <li>جسر التوافق: توصيات عملية للمحاور المنخفضة + جلسات خبراء.</li>
        <li>المتابعة: حجز جلسات، وتطوير مهارات التواصل قبل الزواج.</li>
      </ol>
    </div>
  </section>

  <!-- المزايا -->
  <section id="features" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="card">
      <h2 class="text-xl font-bold mb-4">مزايا المنصّة</h2>
      <ul class="grid md:grid-cols-2 gap-3 text-slate-700 text-sm leading-7">
        <li><i class="fa-regular fa-circle-check ml-2 text-brand"></i>جلسة توافق مزدوجة برمز مشترك</li>
        <li><i class="fa-regular fa-circle-check ml-2 text-brand"></i>تقرير محاور + توصيات قابلة للطباعة</li>
        <li><i class="fa-regular fa-circle-check ml-2 text-brand"></i>شهادة توافق PDF مع QR للاستعلام</li>
        <li><i class="fa-regular fa-circle-check ml-2 text-brand"></i>موافقة وليّ الأمر بتوقيع رقمي</li>
        <li><i class="fa-regular fa-circle-check ml-2 text-brand"></i>لوحة مستشارين وحجوزات (عرض محلي)</li>
      </ul>
    </div>
  </section>

  <!-- اختبار التوافق 30 سؤالًا (جلسة مشتركة) -->
  <section id="test" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="card">
      <h2 class="text-xl font-bold mb-4"><span id="compat-test"></span>اختبار التوافق الذكي (30 سؤالًا)</h2>

      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <label class="text-sm">الدور
          <select id="party" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="male">ذكر</option><option value="female">أنثى</option>
          </select>
        </label>
        <label class="text-sm">المنطقة/البيئة<input id="region" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="مثال: الرياض"></label>
        <label class="text-sm">الديانة/المذهب<input id="religion" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="مثال: الإسلام"></label>
        <label class="text-sm">العمر<input id="age" type="number" min="16" class="mt-1 w-full border rounded-lg px-3 py-2"></label>
        <label class="text-sm">التعليم<input id="edu" class="mt-1 w-full border rounded-lg px-3 py-2"></label>
        <label class="text-sm">الوضع المالي
          <select id="fin" class="mt-1 w-full border rounded-lg px-3 py-2"><option>مستقر</option><option>متوسط</option><option>قيد التحسن</option></select>
        </label>
      </div>

      <div class="flex flex-wrap items-center gap-2 mb-4">
        <button class="btn btn-brand" onclick="createSession()"><i class="fa-solid fa-link ml-1"></i>إنشاء جلسة</button>
        <div class="text-sm">رمز الجلسة: <span class="font-mono" id="sessCode">—</span></div>
        <div class="flex items-center gap-2">
          <input id="joinCode" class="border rounded-lg px-2 py-1 text-sm" placeholder="أدخل رمز جلسة">
          <button class="btn btn-ghost" onclick="joinSession()">انضمام</button>
        </div>
      </div>

      <div id="questions" class="grid md:grid-cols-2 gap-3"></div>
      <div class="mt-3 flex items-center gap-2">
        <button class="btn btn-brand" onclick="submitAnswers()"><i class="fa-solid fa-equals ml-1"></i>احتساب النتائج</button>
        <button class="btn btn-ghost" onclick="clearAnswers()">مسح الإجابات</button>
      </div>

      <!-- النتيجة + جسر التوافق -->
      <div id="resultsArea" class="mt-6 hidden">
        <h3 class="text-lg font-bold mb-1">النتيجة</h3>
        <div class="text-2xl font-extrabold text-brand" id="finalScore">—%</div>
        <div id="axisBreakdown" class="mt-2 text-sm"></div>
        <div class="mt-3 flex flex-wrap gap-2">
          <span class="badge">رقم التوافق: <span class="font-mono" id="compatCode">—</span></span>
          <span class="badge">التاريخ: <span id="compatDate">—</span></span>
        </div>
        <div id="qrContainer" class="mt-3"></div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-brand" onclick="downloadCertificatePDF()"><i class="fa-solid fa-file-pdf ml-1"></i>تنزيل شهادة PDF</button>
          <button class="btn btn-ghost" onclick="window.print()"><i class="fa-solid fa-print ml-1"></i>طباعة</button>
        </div>

        <div id="bridgeBox" class="mt-6 hidden card">
          <div class="text-brand-dk font-bold mb-2"><i class="fa-solid fa-handshake-angle ml-2"></i>جسر التوافق (اقتراحات عملية)</div>
          <ul id="bridgeList" class="text-sm text-slate-700 space-y-1"></ul>
        </div>
      </div>
    </div>
  </section>

  <!-- الوضع الفردي (بروفايل + مطابقات محلية) -->
  <section id="solo" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="card">
      <h2 class="text-xl font-bold mb-3"><span id="individual-mode"></span>الوضع الفردي (بدون شريك)</h2>
      <p class="text-sm text-slate-600 mb-4">احفظ إجاباتك كـ<b>بروفايل فردي</b> ثم اطلب "مطابقات مقترحة" (محليًا) لأقرب نتائج توافق من ملفات محفوظة على هذا الجهاز.</p>

      <div class="grid md:grid-cols-4 gap-3 mb-3">
        <label class="text-sm">اسم تعريفي (اختياري)<input id="soloName" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="مثال: أميرة/سالم"/></label>
        <label class="text-sm">الدور
          <select id="soloRole" class="mt-1 w-full border rounded-lg px-3 py-2"><option value="female">أنثى</option><option value="male">ذكر</option></select>
        </label>
        <label class="text-sm">العمر<input id="soloAge" type="number" min="16" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
        <label class="text-sm">المنطقة<input id="soloRegion" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
      </div>

      <div class="mb-3"><button class="btn btn-ghost" onclick="buildSoloQuestions()"><i class="fa-solid fa-list-check ml-1"></i>تحميل أسئلة الوضع الفردي</button></div>
      <div id="soloQuestions" class="grid md:grid-cols-2 gap-3"></div>

      <div class="mt-3 flex items-center gap-2">
        <button class="btn btn-brand" onclick="saveSoloProfile()"><i class="fa-solid fa-floppy-disk ml-1"></i>حفظ البروفايل الفردي</button>
        <button class="btn btn-ghost" onclick="suggestMatches()"><i class="fa-solid fa-user-group ml-1"></i>مطابقات مقترحة</button>
      </div>

      <div id="soloMatches" class="mt-4 hidden card">
        <div class="font-bold mb-2">أقرب 5 مطابقات (محليًا)</div>
        <div id="matchList" class="text-sm text-slate-700 space-y-1"></div>
      </div>
    </div>
  </section>

  <!-- استعلام الجهات -->
  <section id="verify" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="card">
      <h2 class="text-xl font-bold mb-3"><span id="inquiry"></span>استعلام الجهات برقم التوافق</h2>
      <div class="flex items-center gap-2">
        <input id="verifyCode" class="border rounded-lg px-3 py-2" placeholder="مثال: TWFQ-AB12C-3" aria-label="رقم التوافق"/>
        <button class="btn btn-brand" onclick="lookupVerification()">استعلام</button>
      </div>
      <div id="verifyBox" class="mt-3 hidden"></div>
    </div>
  </section>

  <!-- موافقة وليّ الأمر -->
  <section id="wali" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="card">
      <h2 class="text-xl font-bold mb-2"><span id="guardian-approval"></span>موافقة وليّ الأمر (تجريبية)</h2>
      <p class="text-sm text-gray-600 mb-3">بعد ظهور النتيجة، يمكن تسجيل موافقة وليّ الأمر على رقم التوافق باستخدام توقيع رقمي بسيط.</p>
      <div class="grid md:grid-cols-3 gap-3 mb-2">
        <label class="text-sm">اسم وليّ الأمر<input id="waliName" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
        <label class="text-sm">رقم الهوية<input id="waliNat" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
        <label class="text-sm">رقم التوافق<input id="waliCode" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="TWFQ-..."/></label>
      </div>
      <div class="border rounded-xl p-2 bg-white">
        <canvas id="signPad" class="w-full h-40 bg-sand rounded-lg"></canvas>
      </div>
      <div class="mt-2 flex gap-2">
        <button class="btn btn-brand" onclick="saveWaliConsent()">حفظ الموافقة</button>
        <button class="btn btn-ghost" onclick="clearSign()">مسح التوقيع</button>
      </div>
      <div id="waliMsg" class="text-sm mt-2"></div>
    </div>
  </section>

  <!-- إدارة المستشارين -->
  <section id="advisors-admin" class="max-w-7xl mx-auto px-4 pb-10">
    <div class="card">
      <h2 class="text-xl font-bold mb-2">لوحة إدارة المستشارين (محلي للتجربة)</h2>
      <div class="grid md:grid-cols-4 gap-3 mb-3">
        <label class="text-sm">الاسم<input id="advName" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
        <label class="text-sm">التخصص<input id="advSpec" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="أسري/نفسي/شرعي"/></label>
        <label class="text-sm">أوقات متاحة (مثال: الأحد 6–9|الإثنين 7–10)<input id="advSlots" class="mt-1 w-full border rounded-lg px-3 py-2"/></label>
        <label class="text-sm">الحالة<select id="advApproved" class="mt-1 w-full border rounded-lg px-3 py-2"><option value="0">قيد المراجعة</option><option value="1">معتمد</option></select></label>
      </div>
      <div class="flex gap-2 mb-3">
        <button class="btn btn-brand" onclick="addAdvisor()">إضافة</button>
        <button class="btn btn-ghost" onclick="seedAdvisors()">تعبئة أمثلة</button>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead><tr class="text-right text-gray-600 border-b"><th class="py-2">#</th><th>الاسم</th><th>التخصص</th><th>الأوقات</th><th>الحالة</th><th>إجراءات</th></tr></thead>
          <tbody id="advTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- حجوزات الجلسات -->
  <section id="bookings" class="max-w-7xl mx-auto px-4 pb-12">
    <div class="card">
      <h2 class="text-xl font-bold mb-2">حجوزات الجلسات (تجريبية محلية)</h2>
      <p class="text-sm text-gray-600 mb-4">احجز جلسة مع مستشار معتمد. تُحفَظ الحجوزات محليًا لأغراض العرض.</p>

      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <label class="block text-sm">اختيار المستشار
          <select id="bkAdvisor" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
        </label>
        <label class="block text-sm">نوع الجلسة
          <select id="bkType" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="استشارة أسرية 30 دقيقة">استشارة أسرية 30 دقيقة</option>
            <option value="استشارة نفسية 45 دقيقة">استشارة نفسية 45 دقيقة</option>
            <option value="استشارة شرعية 30 دقيقة">استشارة شرعية 30 دقيقة</option>
          </select>
        </label>
        <label class="block text-sm">التاريخ
          <input id="bkDate" type="date" class="mt-1 w-full border rounded-lg px-3 py-2" />
        </label>
        <label class="block text-sm">الوقت المتاح
          <select id="bkTime" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
        </label>
        <label class="block text-sm md:col-span-2">ملاحظات (اختياري)
          <input id="bkNotes" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="أي تفاصيل إضافية" />
        </label>
      </div>

      <div class="flex items-center gap-2 mb-6">
        <button class="btn btn-brand" onclick="addBooking()"><i class="fa-solid fa-check ml-1"></i>تأكيد الحجز</button>
        <button class="btn btn-ghost" onclick="seedBookings()">تعبئة أمثلة</button>
      </div>

      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-right text-gray-600 border-b">
              <th class="py-2">رقم الحجز</th><th>المستشار</th><th>النوع</th><th>التاريخ</th><th>الوقت</th><th>الحالة</th><th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="bkTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- الاشتراكات -->
  <section id="plans" class="max-w-7xl mx-auto px-4 pb-12">
    <h2 class="text-xl font-bold mb-4">الاشتراكات</h2>
    <div class="grid md:grid-cols-3 gap-6">
      <div class="card hover:shadow-soft transition">
        <div class="text-sm text-slate-500">أساسي</div>
        <div class="text-3xl font-extrabold text-brand mt-1">49 ر.س</div>
        <ul class="text-sm text-slate-700 list-disc pr-5 mt-3 space-y-1"><li>تحقق هوية</li><li>اختبار توافق أساسي</li></ul>
        <button class="btn btn-brand mt-4 w-full" onclick="savePlan('basic')"><i class="fa-solid fa-cart-shopping ml-1"></i>اشترك</button>
      </div>
      <div class="card hover:shadow-soft transition border-2 border-[color:var(--brand)]">
        <div class="text-sm text-slate-500">متقدّم</div>
        <div class="text-3xl font-extrabold text-brand mt-1">149 ر.س</div>
        <ul class="text-sm text-slate-700 list-disc pr-5 mt-3 space-y-1"><li>30 سؤالًا + تقرير محاور</li><li>توصيات ذكية</li></ul>
        <button class="btn btn-brand mt-4 w-full" onclick="savePlan('pro')">اشترك</button>
      </div>
      <div class="card hover:shadow-soft transition">
        <div class="text-sm text-slate-500">نخبوي</div>
        <div class="text-3xl font-extrabold text-brand mt-1">299 ر.س</div>
        <ul class="text-sm text-slate-700 list-disc pr-5 mt-3 space-y-1"><li>جلسة استشارية</li><li>شهادة توافق PDF</li></ul>
        <button class="btn btn-brand mt-4 w-full" onclick="savePlan('elite')">اشترك</button>
      </div>
    </div>
  </section>

  <!-- تواصل -->
  <section id="contact" class="bg-sand/40">
    <div class="max-w-7xl mx-auto px-4 py-10">
      <div class="card">
        <h2 class="text-xl font-bold mb-3"><span id="contact"></span>تواصل معنا</h2>
        <div class="grid md:grid-cols-3 gap-3">
          <label class="text-sm">الاسم<input id="supName" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="اسمك الكامل"/></label>
          <label class="text-sm">البريد<input id="supMail" type="email" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="name@email.com"/></label>
          <label class="text-sm md:col-span-3">رسالتك<textarea id="supMsg" rows="3" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="كيف نقدر نخدمك؟"></textarea></label>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-brand" onclick="saveSupportDraft()">حفظ مسودة</button>
          <button class="btn btn-ghost" onclick="clearSupportDraft()">مسح</button>
        </div>
      </div>
    </div>
  </section>

  <footer class="bg-white border-t">
    <div class="max-w-7xl mx-auto px-4 py-6 text-xs text-slate-600 flex items-center justify-between">
      <span>© جميع الحقوق محفوظة لشركة <b>تلبية للبحث والتطوير</b>.</span>
      <div class="flex items-center gap-2 text-slate-500">
        <span class="chip">هوية: تركوازي/رملي/رمادي</span>
        <span class="chip">Tawāfuq</span>
      </div>
    </div>
  </footer>

  <!-- App Script -->
  <script>
  // ==== Toast ====
  function notify(type, msg){
    const el = document.getElementById('toast');
    const bg = type==='ok' ? 'bg-green-600' : type==='warn' ? 'bg-yellow-600' : 'bg-red-600';
    el.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white ' + bg;
    el.textContent = msg; el.style.opacity=1; el.classList.remove('hidden');
    setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.classList.add('hidden'), 300); }, 2400);
  }

  // ==== Support Draft ====
  const SUP_KEY='tawafuq_support_draft_v1';
  function saveSupportDraft(){ const o={n:supName.value,m:supMail.value,t:supMsg.value}; localStorage.setItem(SUP_KEY, JSON.stringify(o)); notify('ok','تم حفظ المسودة'); }
  function clearSupportDraft(){ localStorage.removeItem(SUP_KEY); supName.value=''; supMail.value=''; supMsg.value=''; notify('ok','تم المسح'); }
  function restoreSupportDraft(){ try{ const o=JSON.parse(localStorage.getItem(SUP_KEY)||'{}'); if(o.n) supName.value=o.n; if(o.m) supMail.value=o.m; if(o.t) supMsg.value=o.t; }catch(e){} }

  // ==== Plans ====
  const PLAN_KEY='tawafuq_plan';
  function savePlan(name){ localStorage.setItem(PLAN_KEY, name); notify('ok','تم حفظ الباقة: '+name); }

  // ==== Advisors Admin ====
  const ADV_KEY='tawafuq_advisors_v1';
  function loadAdvisors(){ try{ return JSON.parse(localStorage.getItem(ADV_KEY))||[] }catch(e){ return [] } }
  function saveAdvisors(x){ localStorage.setItem(ADV_KEY, JSON.stringify(x)); }
  function addAdvisor(){
    const a={ name:advName.value||'مستشار', spec:advSpec.value||'أسري', slots:advSlots.value||'الأحد 6–9', approved: advApproved.value==='1' };
    const list=loadAdvisors(); list.push(a); saveAdvisors(list); renderAdvisors(); notify('ok','تمت الإضافة');
    advName.value=''; advSpec.value=''; advSlots.value=''; advApproved.value='0';
  }
  function deleteAdvisor(i){ const list=loadAdvisors(); list.splice(i,1); saveAdvisors(list); renderAdvisors(); }
  function seedAdvisors(){ const demo=[
    {name:'أ. هدى العتيبي', spec:'أسري', slots:'الأحد 6–9|الثلاثاء 7–10', approved:true},
    {name:'د. مازن القحطاني', spec:'نفسي', slots:'الإثنين 6–9|الأربعاء 6–9', approved:false},
    {name:'الشيخ بندر السبيعي', spec:'شرعي', slots:'الخميس 7–9', approved:true},
  ]; saveAdvisors(demo); renderAdvisors(); notify('ok','تمت تعبئة الأمثلة'); }
  function renderAdvisors(){
    const body=document.getElementById('advTable'); if(!body) return;
    const list=loadAdvisors(); let html='';
    list.forEach((a,i)=>{
      html+=`<tr class="border-b"><td class="py-2">${i+1}</td><td>${a.name}</td><td>${a.spec}</td><td>${a.slots}</td><td>${a.approved?'معتمد':'قيد المراجعة'}</td><td><button class="px-2 py-1 text-xs border rounded-lg text-red-700" onclick="deleteAdvisor(${i})">حذف</button></td></tr>`;
    });
    body.innerHTML=html;
  }

  // ==== Bookings ====
  var BK_KEY='tawafuq_bookings_v1';
  function loadBookings(){ try { return JSON.parse(localStorage.getItem(BK_KEY)) || []; } catch(e){ return []; } }
  function saveBookings(list){ localStorage.setItem(BK_KEY, JSON.stringify(list)); }
  function rebuildAdvisorSelect(){
    var sel = document.getElementById('bkAdvisor'); if(!sel) return;
    var list = loadAdvisors(); var html='';
    for(var i=0;i<list.length;i++){
      var a=list[i]; html += '<option value="'+i+'">'+a.name+' – '+a.spec+' ('+(a.approved? 'معتمد':'قيد المراجعة')+')</option>';
    }
    sel.innerHTML = html; rebuildTimeSlots();
  }
  function parseSlotsToOptions(slots){
    if(!slots) return [];
    var first = String(slots).split('|')[0] || '';
    var m = first.match(/([0-9]+)\s*–\s*([0-9]+)/);
    var s = m? parseInt(m[1]): 6; var e = m? parseInt(m[2]): 9; var out=[];
    for(var h=s; h<e; h++){ out.push(h+':00'); out.push(h+':30'); }
    return out;
  }
  function rebuildTimeSlots(){
    var timeSel = document.getElementById('bkTime'); if(!timeSel) return;
    var advSel = document.getElementById('bkAdvisor'); var list = loadAdvisors();
    var adv = list[advSel && advSel.value ? parseInt(advSel.value) : 0];
    var opts = parseSlotsToOptions(adv? adv.slots: ''); var html='';
    for(var i=0;i<opts.length;i++){ html += '<option value="'+opts[i]+'">'+opts[i]+'</option>'; }
    timeSel.innerHTML = html;
  }
  function uid(){ return 'BK-' + Math.random().toString(36).slice(2,8).toUpperCase(); }
  function addBooking(){
    var advIdx = parseInt((document.getElementById('bkAdvisor')||{}).value||0);
    var list = loadAdvisors(); var adv = list[advIdx];
    if(!adv){ notify('warn','أضف مستشارًا أولًا.'); return; }
    var type = (document.getElementById('bkType')||{}).value;
    var date = (document.getElementById('bkDate')||{}).value;
    var time = (document.getElementById('bkTime')||{}).value;
    var notes = (document.getElementById('bkNotes')||{}).value||'';
    if(!date || !time){ notify('warn','اختر التاريخ والوقت.'); return; }
    var rec = { id: uid(), advisor: adv.name, spec: adv.spec, type: type, date: date, time: time, notes: notes, status: adv.approved? 'مؤكد' : 'بانتظار الاعتماد' };
    var B = loadBookings(); B.push(rec); saveBookings(B); renderBookings();
    try { bookingPDF(rec); } catch(e){}
    notify('ok','تم إنشاء الحجز وإصدار PDF');
  }
  function renderBookings(){
    var body = document.getElementById('bkTable'); if(!body) return;
    var B = loadBookings(); var html='';
    for(var i=0;i<B.length;i++){
      var r=B[i];
      html += '<tr class="border-b">'
        +'<td class="py-2 font-mono">'+r.id+'</td>'
        +'<td>'+r.advisor+' <span class="text-gray-400">('+r.spec+')</span></td>'
        +'<td>'+r.type+'</td>'
        +'<td>'+r.date+'</td>'
        +'<td>'+r.time+'</td>'
        +'<td>'+(r.status==='مؤكد' ? '<span class="badge bg-sand border-[color:var(--brand)] text-brand-dk">مؤكد</span>' : '<span class="badge">بانتظار</span>')+'</td>'
        +'<td class="space-x-2 space-x-reverse">'
          +'<button class="px-2 py-1 text-xs border rounded-lg" onclick="bookingPDFByIndex('+i+')">PDF</button>'
          +'<button class="px-2 py-1 text-xs border rounded-lg text-red-700" onclick="deleteBooking('+i+')">حذف</button>'
        +'</td>'
      +'</tr>';
    }
    body.innerHTML = html; rebuildAdvisorSelect();
    document.getElementById('kpiBookings').textContent = B.length;
  }
  function deleteBooking(i){ var B=loadBookings(); B.splice(i,1); saveBookings(B); renderBookings(); }
  function bookingPDFByIndex(i){ var B=loadBookings(); var rec=B[i]; if(rec) bookingPDF(rec); }
  function bookingPDF(rec){
    var jsPDF = window.jspdf.jsPDF; var doc = new jsPDF('p','pt','a4');
    var y=48; doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text('تأكيد حجز جلسة – Tawāfuq Session Confirmation', 48, y); y+=24;
    doc.setFontSize(12); doc.setFont('helvetica','');
    doc.text('رقم الحجز: '+rec.id, 48, y); y+=16;
    doc.text('المستشار: '+rec.advisor+' ('+rec.spec+')', 48, y); y+=16;
    doc.text('نوع الجلسة: '+rec.type, 48, y); y+=16;
    doc.text('التاريخ: '+rec.date+' | الوقت: '+rec.time, 48, y); y+=16;
    doc.text('الحالة: '+rec.status, 48, y); y+=24;
    if(rec.notes){ doc.text('ملاحظات: '+rec.notes, 48, y); y+=16; }
    doc.save('Booking_'+rec.id+'.pdf');
  }
  function seedBookings(){
    if(loadAdvisors().length===0) seedAdvisors();
    var a=loadAdvisors();
    var demo=[
      {id: uid(), advisor: (a[0]||{name:'أ. هدى'}).name, spec: 'أسري', type:'استشارة أسرية 30 دقيقة', date: new Date().toISOString().slice(0,10), time:'7:30', notes:'', status:'مؤكد'},
      {id: uid(), advisor: (a[1]||{name:'د. مازن'}).name, spec: 'نفسي', type:'استشارة نفسية 45 دقيقة', date: new Date(Date.now()+86400000).toISOString().slice(0,10), time:'6:00', notes:'', status:'بانتظار'}
    ]; saveBookings(demo); renderBookings();
  }

  // ==== KPI Chart (demo) ====
  function renderKPI(){
    if(!window.Chart) return;
    const ctx=document.getElementById('kpiChart'); if(!ctx) return;
    const data={ labels:['جلسات','اختبارات','نسبة توافق متوسطة','مدن'], datasets:[{ label:'مؤشرات', data:[loadBookings().length, 3, 78, 5] }] };
    new Chart(ctx,{ type:'bar', data, options:{ responsive:true, plugins:{legend:{display:false}} } });
  }

  // ==== بنك الأسئلة والمحاور ====
  const AXES=[
    {key:'values', title:'القيم', weight:0.25},
    {key:'goals', title:'الأهداف', weight:0.20},
    {key:'traits', title:'السمات', weight:0.20},
    {key:'finance', title:'المال', weight:0.15},
    {key:'comm', title:'التواصل', weight:0.20},
  ];
  const BANK={
    values:[
      'أهمية الالتزام الديني في الحياة اليومية','أولوية الصدق والشفافية في العلاقة','دور الأسرة الممتدة في اتخاذ القرارات','التمسك بالعادات والتقاليد','المرونة تجاه اختلاف وجهات النظر الدينية','العمل التطوعي كقيمة مشتركة'
    ],
    goals:[
      'الرغبة في إنجاب الأطفال خلال أول عامين','أولوية الاستقرار السكني قبل الإنجاب','التطلع للدراسات العليا بعد الزواج','الطموح المهني لكلا الطرفين','الادخار لهدف طويل المدى','السفر والاستكشاف كأسلوب حياة'
    ],
    traits:[
      'القدرة على ضبط النفس عند الخلاف','التسامح بعد الاعتذار','المرونة في تغيير الخطط','الانفتاح على تجارب جديدة','الدقة في المواعيد','حب النظام والترتيب'
    ],
    finance:[
      'تقسيم المصاريف بشكل متساوٍ','قبول الميزانية الشهرية والانضباط بها','تفضيل الادخار على الاستهلاك','الاستعداد للشفافية المالية الكاملة','تقاسم إدارة أموال الأسرة','الأولويات في الهدايا والرفاه'
    ],
    comm:[
      'حوار يومي لا يقل عن 15 دقيقة','تقبّل النقد البنّاء','الاعتذار السريع عند الخطأ','التعبير عن المشاعر بانتظام','تفضيل حل الخلاف في نفس اليوم','عدم إدخال أطراف خارجية مبكرًا'
    ]
  };

  // ==== جلسة مشتركة ====
  const SESS_KEY='tawafuq_sessions_v3';
  function loadSessions(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY))||{} }catch(e){ return {} } }
  function saveSessions(o){ localStorage.setItem(SESS_KEY, JSON.stringify(o)); }
  function genBase(){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<5;i++){ s+=chars[Math.floor(Math.random()*chars.length)] } return s }
  function genCode(){ const base=genBase(); let sum=0; for(const ch of base){ sum+=ch.charCodeAt(0) } const chk=(sum%7).toString(); return 'TWFQ-'+base+'-'+chk; }
  function validCodeFormat(code){ return /^TWFQ\-[A-Z0-9]{5}\-\d$/.test(code||'') }

  let currentCode=null, currentParty=null;
  function createSession(){
    currentParty = document.getElementById('party').value;
    const meta = { region:region.value||'', religion:religion.value||'', age:parseInt(age.value||'0'), edu:edu.value||'', fin:fin.value||'' };
    const code=genCode(); const sessions=loadSessions();
    sessions[code] = sessions[code]||{ male:null, female:null, meta:{} };
    sessions[code].meta[currentParty]=meta; saveSessions(sessions);
    currentCode=code; document.getElementById('sessCode').textContent=code; notify('ok','تم إنشاء الجلسة: '+code);
    buildQuestions(); restoreProgress();
  }
  function joinSession(){
    const code=(document.getElementById('joinCode').value||'').trim().toUpperCase();
    if(!validCodeFormat(code)) return notify('warn','صيغة الرمز غير صحيحة');
    const s=loadSessions()[code]; if(!s) return notify('err','لا توجد جلسة بهذا الرمز');
    currentCode=code; currentParty=document.getElementById('party').value;
    document.getElementById('sessCode').textContent=code; notify('ok','تم الانضمام إلى الجلسة');
    buildQuestions(); restoreProgress();
  }

  function buildQuestions(){
    const box=document.getElementById('questions'); if(!box) return; box.innerHTML='';
    let i=0; AXES.forEach(ax=>{
      BANK[ax.key].forEach(q=>{
        i++; const id='q_'+ax.key+'_'+i;
        const wrap=document.createElement('label'); wrap.className='text-sm block'; wrap.setAttribute('for', id);
        wrap.innerHTML = i+'. '+q+'<select id="'+id+'" class="mt-1 w-full border rounded-lg px-3 py-2"><option value="">— اختر —</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>';
        box.appendChild(wrap);
      })
    });
    box.querySelectorAll('select').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const key='tawafuq_progress_'+currentCode+'_'+currentParty; const obj=JSON.parse(localStorage.getItem(key)||'{}');
        obj[sel.id]=sel.value; localStorage.setItem(key, JSON.stringify(obj));
      });
    });
  }
  function restoreProgress(){
    if(!currentCode||!currentParty) return;
    const key='tawafuq_progress_'+currentCode+'_'+currentParty; const obj=JSON.parse(localStorage.getItem(key)||'{}');
    Object.keys(obj).forEach(id=>{ const el=document.getElementById(id); if(el) el.value=obj[id]; });
  }
  function clearAnswers(){ const box=document.getElementById('questions'); if(!box) return; box.querySelectorAll('select').forEach(s=>s.value=''); notify('ok','تم المسح'); }

  function gatherAnswersFrom(containerId){
    const box=document.getElementById(containerId); const answers={}; let valid=true;
    AXES.forEach(ax=>{ answers[ax.key]=[]; });
    box.querySelectorAll('select').forEach(s=>{ if(!s.value) valid=false; const key=s.dataset.ax; answers[key].push(parseInt(s.value)); });
    return {answers, valid};
  }

  function similarityScore(a1,a2){
    const len=Math.min(a1.length, a2.length); let sim=0; for(let i=0;i<len;i++){ sim += 1 - (Math.abs(a1[i]-a2[i])/4); } return Math.round((sim/len)*100);
  }
  function demoSimilarity(m,f){
    if(!m||!f) return 0; let s=0, n=0;
    if(m.age && f.age){ const d=Math.abs(m.age-f.age); s += (d<=3?100:(d<=6?70:40)); n++; }
    if(m.edu && f.edu){ s += (m.edu===f.edu?100:60); n++; }
    if(m.region && f.region){ s += (m.region===f.region?100:70); n++; }
    if(m.religion && f.religion){ s += (m.religion===f.religion?100:60); n++; }
    if(m.fin && f.fin){ s += (m.fin===f.fin?100:70); n++; }
    return Math.round(s/Math.max(n,1));
  }

  function gatherAnswers(){
    const box=document.getElementById('questions'); const answers={}; let valid=true;
    AXES.forEach(ax=>{ answers[ax.key]=[]; });
    box.querySelectorAll('select').forEach(s=>{
      if(!s.value) valid=false;
      const parts=s.id.split('_'); const key=parts[1]; answers[key].push(parseInt(s.value));
    });
    return {answers, valid};
  }

  function bridgeTips(axisScores){
    const tips={
      values:['جلسة مشتركة حول القيم غير المتطابقة وكتابة نقاط التقاء','اتفاق مكتوب على حدود العادات/الممارسات المختلف عليها'],
      goals:['خارطة 12 شهرًا للأولويات (سكن/وظيفة/تعليم)','ميزانية مشتركة وادخار لهدف واضح'],
      traits:['قائمة محفزات الغضب لكل طرف وخطة تهدئة','تدريب على الإصغاء العاكس لمدة 10 دقائق يوميًا'],
      finance:['اجتماع مالي أسبوعي بحد أقصى 20 دقيقة','تقسيم أدوار: من يدير الفواتير ومن يدير الادخار'],
      comm:['قاعدة 24 ساعة لحل الخلاف','جملة آمِنة لبدء الحوار بدون هجوم (أنا أشعر...)']
    };
    let out=[];
    Object.entries(axisScores).forEach(([k,v])=>{
      if(v<60){ out.push(`محور <b>${({values:'القيم',goals:'الأهداف',traits:'السمات',finance:'المال',comm:'التواصل'})[k]}</b> منخفض (${v}%). ${tips[k][0]} — ${tips[k][1]}.`); }
    });
    return out;
  }

  function submitAnswers(){
    if(!currentCode||!currentParty) return notify('warn','أنشئ أو انضم إلى جلسة أولًا');
    const pack=gatherAnswers(); if(!pack.valid) return notify('warn','أكمل جميع الإجابات');
    const sessions=loadSessions(); const S=sessions[currentCode]||{ male:null, female:null, meta:{} };
    const meta={ region:region.value, religion:religion.value, age:parseInt(age.value||'0'), edu:edu.value, fin:fin.value };
    S[currentParty]={ answers:pack.answers, meta }; sessions[currentCode]=S; saveSessions(sessions);

    if(S.male && S.female){
      const axisScores={}; let total=0;
      AXES.forEach(ax=>{
        const a1=S.male.answers[ax.key]; const a2=S.female.answers[ax.key];
        const sim=similarityScore(a1,a2); axisScores[ax.key]=sim; total += sim*ax.weight;
      });
      const dm = demoSimilarity(S.male.meta, S.female.meta);
      const final = Math.round(total*0.75 + dm*0.25);
      showResults(final, axisScores);
      document.getElementById('kpiTests').textContent = (parseInt(document.getElementById('kpiTests').textContent||'0')+1);
      document.getElementById('kpiAvg').textContent = final+'%';
      localStorage.removeItem('tawafuq_progress_'+currentCode+'_male');
      localStorage.removeItem('tawafuq_progress_'+currentCode+'_female');
    } else {
      notify('ok','تم حفظ إجاباتك. بانتظار الطرف الآخر.');
    }
  }

  function showResults(final, axis){
    const code = currentCode; const date=new Date().toLocaleDateString('ar-SA');
    document.getElementById('resultsArea').classList.remove('hidden');
    document.getElementById('finalScore').textContent=final+'%';
    document.getElementById('compatCode').textContent=code;
    document.getElementById('compatDate').textContent=date;
    const mapTitle={values:'القيم', goals:'الأهداف', traits:'السمات', finance:'المال', comm:'التواصل'};
    let html=''; Object.keys(axis).forEach(k=>{ html+=`<span class="badge">${mapTitle[k]}: ${axis[k]}%</span> `; });
    document.getElementById('axisBreakdown').innerHTML=html;

    const qrBox=document.getElementById('qrContainer'); qrBox.innerHTML='';
    const div=document.createElement('div'); qrBox.appendChild(div);
    const payload = JSON.stringify({code, score:final});
    new QRCode(div, {text: payload, width:128, height:128});

    // جسر التوافق
    const tips=bridgeTips(axis);
    const bb=document.getElementById('bridgeBox');
    const bl=document.getElementById('bridgeList');
    if(tips.length){ bl.innerHTML=tips.map(t=>`<li>${t}</li>`).join(''); bb.classList.remove('hidden'); } else { bb.classList.add('hidden'); }

    notify('ok','تم احتساب النتيجة');
  }

  function dataURLFromQRCodeElement(el){
    const img=el.querySelector('img'); if(img) return img.src;
    const cvs=el.querySelector('canvas'); if(cvs) return cvs.toDataURL('image/png');
    return null;
  }

  function downloadCertificatePDF(){
    const jsPDF=window.jspdf.jsPDF; const doc=new jsPDF('p','pt','a4');
    const code=document.getElementById('compatCode').textContent||'';
    const score=document.getElementById('finalScore').textContent||'';
    const date=document.getElementById('compatDate').textContent||'';
    let y=56; doc.setFont('helvetica','bold'); doc.setFontSize(20);
    doc.text('شهادة توافق – Tawāfuq Compatibility Certificate', 48, y); y+=28;
    doc.setFont('helvetica',''); doc.setFontSize(12);
    doc.text('رقم التوافق: '+code, 48, y); y+=16; doc.text('النسبة النهائية: '+score, 48, y); y+=16; doc.text('التاريخ: '+date, 48, y); y+=24;
    const qc=document.getElementById('qrContainer'); const dataURL=dataURLFromQRCodeElement(qc);
    if(dataURL){ doc.addImage(dataURL, 'PNG', 48, y, 96, 96); y+=112; }
    doc.text('هذه شهادة تجريبية محلية لأغراض العرض.', 48, y);
    doc.save('Tawafuq_Certificate_'+code+'.pdf');
  }

  // ==== Verify lookup ====
  function lookupVerification(){
    const code=(document.getElementById('verifyCode').value||'').trim().toUpperCase();
    const box=document.getElementById('verifyBox'); box.classList.remove('hidden');
    if(!/^TWFQ\-[A-Z0-9]{5}\-\d$/.test(code||'')){ box.innerHTML='<div class="text-red-700">صيغة الرقم غير صحيحة.</div>'; return; }
    const S=loadSessions()[code]; if(!S||!S.male||!S.female){ box.innerHTML='<div class="text-yellow-700">لا تتوفر بيانات مكتملة لهذا الرقم.</div>'; return; }
    const axis={}; let total=0; AXES.forEach(ax=>{ const sim=similarityScore(S.male.answers[ax.key], S.female.answers[ax.key]); axis[ax.key]=sim; total+=sim*ax.weight; });
    const dm=demoSimilarity(S.male.meta,S.female.meta); const final=Math.round(total*0.75+dm*0.25);
    const mapTitle={values:'القيم', goals:'الأهداف', traits:'السمات', finance:'المال', comm:'التواصل'};
    let badges=''; Object.keys(axis).forEach(k=>{ badges+=`<span class="badge">${mapTitle[k]}: ${axis[k]}%</span> `; });
    box.innerHTML = `<div class="p-3 bg-white border rounded-xl"><div class="text-lg font-bold text-brand">${final}%</div><div class="mt-2">${badges}</div><div class="text-xs text-gray-500 mt-2">نتيجة محسوبة محليًا (تجريبي)</div></div>`;
  }

  // ==== توقيع الولي ====
  let drawing=false;
  function signInit(){ const c=document.getElementById('signPad'); if(!c) return; const ctx=c.getContext('2d'); ctx.strokeStyle='#000'; ctx.lineWidth=2;
    function pos(e){ const r=c.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; }
    c.addEventListener('mousedown',e=>{drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y)});
    c.addEventListener('mousemove',e=>{ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
    window.addEventListener('mouseup',()=>drawing=false);
    c.addEventListener('touchstart',e=>{drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y)});
    c.addEventListener('touchmove',e=>{ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
    window.addEventListener('touchend',()=>drawing=false);
  }
  function clearSign(){ const c=document.getElementById('signPad'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
  function saveWaliConsent(){
    const name=waliName.value||''; const nat=waliNat.value||''; const code=(waliCode.value||'').toUpperCase();
    if(!name||!nat||!/^TWFQ\-[A-Z0-9]{5}\-\d$/.test(code)) return notify('warn','أكمل البيانات وتحقق من صيغة الرقم');
    const S=loadSessions(); if(!S[code]) return notify('err','رقم توافق غير موجود');
    const c=document.getElementById('signPad'); const png=c.toDataURL('image/png');
    S[code].wali={ name, nat, sign: png, at: new Date().toISOString() }; saveSessions(S);
    document.getElementById('waliMsg').textContent='تم حفظ موافقة وليّ الأمر.'; notify('ok','حُفظت الموافقة');
  }

  // ==== الوضع الفردي ====
  const SOLO_KEY='tawafuq_solo_profiles_v1';
  function loadSolo(){ try{ return JSON.parse(localStorage.getItem(SOLO_KEY))||[] }catch(e){ return [] } }
  function saveSolo(list){ localStorage.setItem(SOLO_KEY, JSON.stringify(list)); }
  function buildSoloQuestions(){
    const box=document.getElementById('soloQuestions'); if(!box) return; box.innerHTML='';
    let i=0; AXES.forEach(ax=>{
      BANK[ax.key].forEach(q=>{
        i++; const id='s_'+ax.key+'_'+i;
        const wrap=document.createElement('label'); wrap.className='text-sm block'; wrap.htmlFor=id;
        wrap.innerHTML = i+'. '+q+`<select id="${id}" data-ax="${ax.key}" class="mt-1 w-full border rounded-lg px-3 py-2"><option value="">— اختر —</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>`;
        box.appendChild(wrap);
      })
    });
  }
  function saveSoloProfile(){
    const pack=gatherAnswersFrom('soloQuestions'); if(!pack.valid) return notify('warn','أكمل جميع إجابات الوضع الفردي');
    const name=(soloName.value||'بروفايل'); const role=soloRole.value||'female';
    const meta={ age:parseInt(soloAge.value||'0'), region:soloRegion.value||'' };
    const list=loadSolo();
    list.push({ id:'P-'+Math.random().toString(36).slice(2,7), name, role, meta, answers:pack.answers, at:new Date().toISOString() });
    saveSolo(list); notify('ok','تم حفظ البروفايل الفردي');
  }
  function vectorize(ans){ return AXES.flatMap(ax=>ans[ax.key]||[]); }
  function simVec(a,b){ const n=Math.min(a.length,b.length); let s=0; for(let i=0;i<n;i++){ s += 1 - (Math.abs(a[i]-b[i])/4); } return Math.round((s/n)*100); }
  function suggestMatches(){
    const list=loadSolo(); if(list.length<2){ notify('warn','لا توجد بيانات كافية للمطابقة على هذا الجهاز'); return; }
    // آخر بروفايل محفوظ هو صاحب الطلب
    const me=list[list.length-1]; const meVec=vectorize(me.answers);
    const targets=list.filter(p=>p!==me && p.role!==me.role);
    const scored=targets.map(p=>({p,score:simVec(meVec, vectorize(p.answers))})).sort((a,b)=>b.score-a.score).slice(0,5);
    const box=document.getElementById('soloMatches'); const ul=document.getElementById('matchList');
    ul.innerHTML=scored.map(r=>`<div>• <b>${r.p.name}</b> (${r.p.role==='male'?'ذكر':'أنثى'}) — توافق تقريبي: <b class="text-brand">${r.score}%</b></div>`).join('') || 'لا توجد مطابقات.';
    box.classList.remove('hidden');
  }

  // ==== KPI mini hydrate ====
  function hydrateMiniKPIs(){
    const avgEl=document.getElementById('kpiAvg');
    if(avgEl.textContent==='—%'){ avgEl.textContent='78%'; }
  }

  // ==== Init ====
  document.addEventListener('DOMContentLoaded',function(){
    restoreSupportDraft();
    renderAdvisors(); rebuildAdvisorSelect(); renderBookings();
    renderKPI(); hydrateMiniKPIs(); signInit();
  });
  </script>
</body>
</html>
